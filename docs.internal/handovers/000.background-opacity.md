# b\_style • Backgrounds & Pseudos — Handover + Action Plan (v1)

Last updated: **Aug 30, 2025**
Owner: **Stuart** + Assist
Scope: **Background editor** with baked opacity, per-layer blend mode, and pseudo-element support. Future channels (text/svg) placeholders included; mix-blend-mode parked for element-style pass.

---

## 1) Final Decisions (Locked)

* **Model unit:** `BStyleElement` (bundle of base + optional pseudos).
* **Flat model:** No DOM-like nesting. One element per host; pseudos live inside the bundle.
* **Flat model & stacking:** The editor models one host as a single BStyleElement (a bundle containing the base box plus optional ::before/::after). A project can contain many BStyleElements, arranged in an explicit order that defines visual stacking (top → bottom). There are no DOM-like parent/child relationships between BStyleElements; pseudos live inside their host bundle, and hosts are peers in a flat list.
* **Schema versioning:** `version: 1` on `BStyleElement` for forward migrations.
* **Background IR:** Keep existing `BackgroundIRSchema` / `BackgroundLayerSchema` as-is.
* **Opacity:** **Bake-only** (edit gradient/solid color stops). `url()` layers unchanged.
* **Blend modes:** `background-blend-mode` per layer; aligned with layer count; fill missing with `normal`.
* **Stack color:** `background-color` remains at the stack level inside `BackgroundIR`.
* **Mix-blend-mode:** **Parked** for future element-style pass (sibling to `isolation`, filters, etc.).
* **Pseudo content:** Tri-state semantics on each pseudo: `undefined` → allow auto `content:""` by serializer option; `null` → emit no `content`; `string` → emit exactly (quoted).
* **Layout hints on pseudo:** Data fields (not global-only): `cover`, `pointerEventsNone`, optional `zIndex`.
* **Selector strategy:** If `selector` missing, synthesize a stable class (e.g., `.bstyle-<shortId>`) on first serialize.
* **UUIDs:** Generate v4 UUID for `BStyleElement.id`. On parse, mint a new `id` per grouped selector. (No separate hostId needed in bundle form.)
* **At-least-one channel rule:** `base.bg` OR `pseudos.before.bg` OR `pseudos.after.bg` **must** be present.
* **Meta:** Optional provenance for debugging.

---

## 2) Canonical Schemas (Zod-first, names stable)

> **Note:** This is the *contract*. Implementation can derive TypeScript types via `z.infer`.

### 2.1 `PseudoChannels`

* `bg?: BackgroundIR` — background channel for the pseudo.
* `text?: any` — placeholder (future `TextIRSchema`).
* `svg?: any` — placeholder (future `SvgIRSchema`).
* `content?: string | null` — tri-state pseudo content.
* `cover: boolean = false` — if `true`, serializer may emit `position:absolute; inset:0`.
* `pointerEventsNone: boolean = false`
* `zIndex?: number`

### 2.2 `BStyleElement`

* `version: 1`
* `id: uuid`
* `selector?: string` — base selector without pseudo (e.g., `.card`).
* `tag: string = "div"` — hint for preview/serialize (e.g., `div`, `body`).
* `meta?: { source?: "parsed" | "editor"; note?: string }`
* `base: { bg?: BackgroundIR }` — background channel at base; optional per decision.
* `pseudos?: { before?: PseudoChannels; after?: PseudoChannels }`

**Constraint:** At least one of `base.bg`, `pseudos.before.bg`, `pseudos.after.bg` must exist.

---

## 3) Parse / Serialize Contracts

### 3.1 `parseBStyleElements(css: string): BStyleElement[]`

**Input:** CSS text (rule sets for selectors including optional `::before`/`::after`).

**Behavior:**

1. **Group by selector sans pseudo.** E.g., `.tile`, `.tile::before`, `.tile::after` → one bundle.
2. **Source-order expansion.** Expand each `background` shorthand into its longhands; later longhands override earlier values.
3. **Layer arity from `background-image`.** Last `background-image` wins; pad/align other per-layer longs to that count (use spec defaults).
4. **Stack color.** Read `background-color` into IR’s stack-level color.
5. **Blend modes.** Read `background-blend-mode` as a list; align to layer count (pad with `normal`).
6. **Pseudos.** If `::before`/`::after` exist, map to `pseudos.*` and parse their channels as in base.
7. **Pseudo `content`.**

   * Quoted string → `content = string` (unquoted value).
   * `none|normal` → `content = null`.
   * Absent → `content = undefined`.
8. **IDs & metadata.** Create one `BStyleElement` per group with `id = uuid`, `selector` captured, `meta.source = "parsed"`.
9. **Validation.** Ensure the at-least-one channel rule holds; drop empty bundles.

**Output:** Array of `BStyleElement` bundles.

### 3.2 `serializeBStyleElements(els: BStyleElement[], opts): string`

**Options:**

* `ensurePseudoContent: boolean = true` — when a pseudo’s `content` is `undefined` and a pseudo channel exists, emit `content:""`.

**Behavior:** For each `BStyleElement` (in given order):

1. **Selector:** Use `selector` if present; else synthesize `.bstyle-<shortId>` and (optionally) persist it.
2. **Base rule:** If `base.bg` exists, serialize background declarations with **baked opacity** for gradient/solid color stops. Emit stack color; emit `background-blend-mode` aligned to layer count.
3. **Pseudos:** For each present pseudo:

   * Compose `selector::before|::after`.
   * Emit `content` per tri-state rules (apply `ensurePseudoContent`).
   * If `cover` → also emit `position:absolute; inset:0`.
   * Respect `pointerEventsNone`, `zIndex` when set.
   * Serialize its `bg` exactly as base.
4. **Whitespace & order:** Maintain stable, readable output formatting.

**Bake transformer:**

* For each layer with `opacity`:

  * If color stop already has alpha → multiply by `opacity` and clamp \[0..1].
  * If no alpha → add an alpha channel with value `opacity`.
  * Supported syntaxes: hex (#rgb/#rgba/#rrggbb/#rrggbbaa), `rgb[a]?`, `hsl[a]?`, `hwb`, `lab`, `lch`, `oklab`, `oklch`, `color(<space> … [/ a])`.
  * `url()` and non-color tokens unchanged.
* Preserve original spacing and token order (AST-driven, not regex).

**Friendly warnings (non-fatal):**

* If a layer has `opacity` but image is non-color (`url()`), note: “Opacity applies to gradient/solid layers; image left unchanged.”
* If blend list is shorter than layer count, pad with `normal`.

---

## 4) Test Plan (High-value cases)

1. **Bake: mixed formats** — gradient with hex + rgb + oklch; `opacity=0.25`. Verify alphas set/multiplied; spacing preserved.
2. **Bake: partial alpha** — stop with `/ 0.5` becomes `/ 0.125`; neighbors gain `/ 0.25`.
3. **Non-color unchanged** — `url(photo.jpg)` with `opacity=0.6` stays identical.
4. **Blend alignment** — 3 layers, modes `["screen", undefined, "multiply"]` → emit `background-blend-mode: screen, normal, multiply;`.
5. **Stack color** — `background-color` round-trips through IR.
6. **Pseudos content** — explicit string, explicit `none`, and `undefined` + `ensurePseudoContent`.
7. **Parse precedence** — `background` then later `background-image` overrides image list; arity re-aligns.
8. **Constraint** — bundle with only `pseudos.after.bg` passes (no base). Empty bundle rejected.

---

## 5) Milestones (Do-first order)

**M1 — Schema & Guards**

* Add `version: 1` to `BStyleElement`.
* Implement Zod schemas: `BStyleElement`, `PseudoChannels`.
* Add constraint validation: at-least-one channel present.

**M2 — Bake Transformer**

* Implement `bakeOpacityIntoImage(image: string, alpha: number): string` using AST.
* Channel support: hex/rgb/hsl/hwb/lab/lch/oklab/oklch/`color()`.
* Unit tests for all color families.

**M3 — Serialize (bg only)**

* `serializeBStyleElements(els, opts)` with:

  * selector resolution/synthesis,
  * base + pseudo rule generation,
  * bake integration per layer,
  * blend-mode alignment,
  * stack color emission,
  * pseudo content/cover/pointer-events/zIndex handling.
* Add friendly warnings.

**M4 — Parse (bg only)**

* Expand `background` → longhands; last-write-wins; arity from `background-image`.
* Build bundles from grouped selectors; mint UUIDs; set `meta.source = "parsed"`.
* Tests for shorthand/longhand interplay and pseudos.

**M5 — Perf & UX polish**

* Memoize bake by `(image, opacity)`.
* Diagnostic badges for padded blend list and ignored opacity on non-color images.
* Persist synthesized selector back to data (optional).

*(Future)* **M6 — Text/SVG channels** (design & minimal schema; out-of-scope for now)

---

## 6) Definition of Done (DoD)

* [ ] Zod schemas ship with `version: 1` and constraint guards.
* [ ] Serialize produces valid CSS for base and pseudos; passes all tests.
* [ ] Bake transformer covers all color syntaxes; spacing preserved.
* [ ] Parse reconstructs bundles correctly from complex shorthand/longhand mixes.
* [ ] Warnings logged for ignored opacity on non-color and blended list padding.
* [ ] Zero `any`, modern TS only, types inferred from Zod.

---

## 7) Open Questions (Track & close)

* Do we persist synthesized selectors back to `selector` on first serialize?
* Should pseudos default to `cover: true` in the editor UX? (Serializer honors the data; UX default can differ.)
* Do we want to support `background-attachment` nuances in pseudos (usually irrelevant when `cover` is used)?

---

## 8) Quick Glossary

* **Bundle / BStyleElement** — one host’s base + pseudos.
* **Bake** — editing color stops to realize opacity.
* **Stack color** — `background-color` behind image layers.
* **Layer arity** — number of comma-separated background layers.
* **Padded blend list** — adding `normal` to match arity.

---

## 9) Next Step (Implementation pick)

Start **M1**: introduce the Zod schemas + guards, then kick off **M2** (bake transformer). After that, wire **M3** (serialize) and **M4** (parse), landing tests as we go.
